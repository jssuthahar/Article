
# Call Azure Function Using System Assigned Managed Identity in C\#

## Description

This project demonstrates how to implement a C# application that securely calls Azure resources (e.g., **Key Vault**, **Storage**) using a **System Assigned Managed Identity** provided by Azure.

Azure automatically creates and manages this identity, which is tied to the lifecycle of the Function App.

## Use Case

Use **System Assigned Managed Identity** to securely access Azure resources **without** storing or managing credentials.

Example:

* Access secrets from **Azure Key Vault**
* Read/write blobs from **Azure Storage Account**

---

## Configuration

### 1. Enable System Assigned Identity

1. Navigate to your Function App in the Azure Portal.
2. Go to **Identity** under **Settings**.
3. Under **System assigned**, set **Status** to **On**.
4. Click **Save** to enable the identity.

### 2. Assign Roles to the Identity

Assign appropriate roles to the identity to allow it to access the target Azure resources:

* Go to the resource (e.g., **Key Vault**, **Storage Account**)
* Select **Access Control (IAM)** > **Add role assignment**
* Choose a role (e.g., **Key Vault Reader**, **Storage Blob Data Contributor**)
* Assign it to the **Function App's managed identity**

---

## Sample C# Code

```csharp
using Azure.Identity;
using Azure.Security.KeyVault.Secrets;

public class SecretReader
{
    public async Task<string> GetSecretAsync(string vaultUri, string secretName)
    {
        var credential = new DefaultAzureCredential();
        var client = new SecretClient(new Uri(vaultUri), credential);
        KeyVaultSecret secret = await client.GetSecretAsync(secretName);
        return secret.Value;
    }
}
```

> `DefaultAzureCredential` will automatically use the managed identity when the code runs in Azure.

---

## Requirements

* .NET 6 or later
* Azure Function App with System Assigned Identity enabled
* Azure SDKs (e.g., `Azure.Identity`, `Azure.Security.KeyVault.Secrets`)

---

## References

* [Azure Managed Identities Documentation](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/)
* [DefaultAzureCredential Documentation](https://learn.microsoft.com/en-us/dotnet/api/azure.identity.defaultazurecredential)

---

Let me know if you want a version of this tailored for **Azure Storage**, **App Configuration**, or a different Azure service.


Certainly! Here's an updated version of the `README.md` that includes a note on troubleshooting when `DefaultAzureCredential()` does not work as expected:

---

# Call Azure Function Using System Assigned Managed Identity in C\#

## Description

This project demonstrates how to implement a C# application that securely calls Azure resources (e.g., **Key Vault**, **Storage**) using a **System Assigned Managed Identity** provided by Azure.

Azure automatically creates and manages this identity, which is tied to the lifecycle of the Function App.

## Use Case

Use **System Assigned Managed Identity** to securely access Azure resources **without** storing or managing credentials.

Example:

* Access secrets from **Azure Key Vault**
* Read/write blobs from **Azure Storage Account**

---

## Configuration

### 1. Enable System Assigned Identity

1. Navigate to your Function App in the Azure Portal.
2. Go to **Identity** under **Settings**.
3. Under **System assigned**, set **Status** to **On**.
4. Click **Save** to enable the identity.

### 2. Assign Roles to the Identity

Assign appropriate roles to the identity to allow it to access the target Azure resources:

* Go to the resource (e.g., **Key Vault**, **Storage Account**)
* Select **Access Control (IAM)** > **Add role assignment**
* Choose a role (e.g., **Key Vault Reader**, **Storage Blob Data Contributor**)
* Assign it to the **Function App's managed identity**

---

## Sample C# Code

```csharp
using Azure.Identity;
using Azure.Security.KeyVault.Secrets;

public class SecretReader
{
    public async Task<string> GetSecretAsync(string vaultUri, string secretName)
    {
        var credential = new DefaultAzureCredential();
        var client = new SecretClient(new Uri(vaultUri), credential);
        KeyVaultSecret secret = await client.GetSecretAsync(secretName);
        return secret.Value;
    }
}
```

> `DefaultAzureCredential` will automatically use the managed identity when the code runs in Azure.

---

## Troubleshooting

### ‚ùó `DefaultAzureCredential()` Not Working?

If you're encountering issues with authentication using `DefaultAzureCredential`, check the following:

* ‚úÖ **System Assigned Identity is enabled** for the Function App.
* ‚úÖ The **Function App identity has the required permissions** (e.g., Key Vault Reader).
* ‚úÖ You are not running the code locally without fallback credentials (e.g., `VisualStudioCredential`).
* üõ†Ô∏è Use `Azure.Identity` diagnostic logging to debug credential resolution:

```csharp
AzureIdentityEventSource.Logger.SetLogLevel(SourceLevels.Verbose);
```

Or inspect errors by catching exceptions:

```csharp
try
{
    var credential = new DefaultAzureCredential();
    var client = new SecretClient(new Uri(vaultUri), credential);
    var secret = await client.GetSecretAsync(secretName);
}
catch (AuthenticationFailedException ex)
{
    Console.WriteLine($"Authentication failed: {ex.Message}");
}
```

---

## Requirements

* .NET 6 or later
* Azure Function App with System Assigned Identity enabled
* Azure SDKs:

  * `Azure.Identity`
  * `Azure.Security.KeyVault.Secrets` (or other resource SDKs)

---

## References

* [Azure Managed Identities Documentation](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/)
* [DefaultAzureCredential Documentation](https://learn.microsoft.com/en-us/dotnet/api/azure.identity.defaultazurecredential)

## Connect with Me
- **LinkedIn**: [Suthahar Jeganathan](https://www.linkedin.com/in/jssuthahar/)
- **YouTube**: [MSDEVBUILD](https://www.youtube.com/@MSDEVBUILD)
- **YouTube Tamil**: [MSDEVBUILD TAMIL](https://www.youtube.com/@MSDEVBUILDTamil)
- **Blog**: [Blog](https://www.msdevbuild.com/)
- **Follow Whatsapp**: [Whatsapp](https://www.whatsapp.com/channel/0029Va5j2rHEFeXcTlUhQB0J)
---

Let me know if you want to add local development support or target other Azure services like Blob Storage or App Config.
