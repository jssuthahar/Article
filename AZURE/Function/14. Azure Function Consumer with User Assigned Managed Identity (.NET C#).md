
# Azure Function Consumer with User Assigned Managed Identity (.NET C#)

## What is UAMI?

**UAMI** stands for **User Assigned Managed Identity** ‚Äî a type of Managed Identity in Azure.

Azure Managed Identities allow your application to authenticate to Azure services **without storing credentials** in your code. A **User Assigned Managed Identity** is:

- Created as a **standalone Azure resource**.
- Can be **assigned to multiple Azure services** (e.g., VM, Function App, Web App).
- Managed separately from the resources it‚Äôs assigned to.
- Useful when you want **centralized control over identity and access**.

### üîë Benefits of UAMI:
- Share a single identity across multiple applications or services.
- Granular access control from a central place.
- No hardcoded credentials, improving security and maintainability.

---

## üîß Prerequisites

- [.NET 6.0 SDK or later](https://dotnet.microsoft.com/en-us/download)
- Azure Subscription
- Azure Function App (with authentication enabled)
- A deployed **User Assigned Managed Identity**

---

## üì¶ Project Setup

1. Clone the repository:

   ```bash
   git clone https://github.com/your-org/azure-function-uami-consumer.git
   cd azure-function-uami-consumer
````

2. Restore dependencies:

   ```bash
   dotnet restore
   ```

---

## ‚öôÔ∏è UAMI Configuration in Azure

### 1. Create a User Assigned Managed Identity

* Go to **Azure Portal > Azure Active Directory > Managed Identities**.
* Click **+ New**.
* Provide a name, subscription, and resource group.
* Click **Create**.

### 2. Assign UAMI to the Consumer App

For example, to assign it to an Azure Function App:

* Go to your **Function App > Identity > User assigned > + Add**.
* Select the UAMI you created.
* Click **Add**.

### 3. Grant Permissions to the UAMI

* Navigate to the target Azure resource (e.g., Function App, Key Vault).
* Go to **Access Control (IAM) > + Add > Role Assignment**.
* Choose a role (e.g., **Function App Contributor**, **Reader**, etc.).
* Under **Assign access to**, select **Managed identity** and choose the UAMI.

---

## üîê Calling an Azure Function with UAMI in C\#

Use the `Azure.Identity` library to authenticate with UAMI and call the Azure Function:

```csharp
using Azure.Core;
using Azure.Identity;
using System.Net.Http.Headers;

// Replace with your UAMI Client ID and Function endpoint
string uamiClientId = "<your-uami-client-id>";
string functionUrl = "<your-function-url>"; // e.g., https://your-func.azurewebsites.net/api/YourEndpoint

var credential = new ManagedIdentityCredential(clientId: uamiClientId);
var accessToken = await credential.GetTokenAsync(
    new TokenRequestContext(new[] { "https://<function-app-name>.azurewebsites.net/.default" })
);

using var httpClient = new HttpClient();
httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken.Token);

var response = await httpClient.GetAsync(functionUrl);
var content = await response.Content.ReadAsStringAsync();

Console.WriteLine(content);
```

> üîé **Note**: Ensure Azure Function App has Azure AD authentication enabled and is configured to accept tokens.

---

## ‚úÖ Expected Output

The C# application will securely call the Azure Function using the assigned UAMI and display the result.

---

## üìÑ References

* [Managed Identity Documentation](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/)
* [Azure.Identity NuGet Package](https://www.nuget.org/packages/Azure.Identity)
* [Secure an Azure Function with Azure AD](https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger?tabs=csharp#authorization-levels)

---

## üß™ Testing

Test the app locally or deploy it in Azure with the UAMI assigned. Use Application Insights or the Azure Function logs to verify successful, authorized access.

## Connect with Me
- **LinkedIn**: [Suthahar Jeganathan](https://www.linkedin.com/in/jssuthahar/)
- **YouTube**: [MSDEVBUILD](https://www.youtube.com/@MSDEVBUILD)
- **YouTube Tamil**: [MSDEVBUILD TAMIL](https://www.youtube.com/@MSDEVBUILDTamil)
- **Blog**: [Blog](https://www.msdevbuild.com/)
- **Follow Whatsapp**: [Whatsapp](https://www.whatsapp.com/channel/0029Va5j2rHEFeXcTlUhQB0J)
